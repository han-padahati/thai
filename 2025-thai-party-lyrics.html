<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025年慢一鐘頭的泰文歌同樂會歌單</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Sarabun:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', 'Sarabun', sans-serif;
            background-color: #f8fafc;
        }

        .lyrics-container {
            transition: font-size 0.2s ease-in-out;
        }

        .thai-text {
            color: #1e293b;
            font-weight: 700;
            margin-bottom: 0.25rem;
            line-height: 1.5;
        }

        .chinese-text {
            color: #64748b;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media print {
            .no-print { display: none !important; }
            .print-area { padding: 20px !important; background: white !important; }
        }
    </style>
</head>
<body class="min-h-screen text-slate-800">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-10 no-print">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <!-- <h1 class="text-xl md:text-2xl font-bold text-blue-600 text-center">2025年慢一鐘頭的泰文歌同樂會歌單</h1> -->
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-6">
        
        <!-- Controls Section -->
        <div id="controls" class="bg-white p-4 rounded-xl shadow-sm mb-6 space-y-4 no-print">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <!-- Song Selector -->
                <div class="flex-1">
                    <!-- <label class="block text-sm font-medium text-slate-500 mb-1">選擇歌曲</label> -->
                    <select id="songSelect" class="w-full border-slate-200 border rounded-lg px-3 py-2 bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                        <option value="">載入中...</option>
                    </select>
                </div>

                <!-- Font Adjust & PDF -->
                <div class="flex items-center gap-3">
                    <div class="flex items-center bg-slate-100 rounded-lg p-1">
                        <button onclick="adjustFontSize(-2)" class="p-2 hover:bg-white rounded-md transition shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </button>
                        <span id="fontSizeDisplay" class="px-3 font-medium text-sm">18px</span>
                        <button onclick="adjustFontSize(2)" class="p-2 hover:bg-white rounded-md transition shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </button>
                    </div>
                    <!-- <button id="downloadPdf" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition shadow-md disabled:opacity-50">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                      
                    </button> -->
                </div>
            </div>
        </div>

        <!-- Loading View -->
        <div id="loading" class="flex flex-col items-center justify-center py-20 hidden">
            <div class="spinner mb-4"></div>
            <p id="loadingText" class="text-slate-500 text-center">正在獲取歌單資料...</p>
        </div>

        <!-- Lyrics Display -->
        <div id="lyricsDisplay" class="bg-white p-8 md:p-12 rounded-2xl shadow-sm min-h-[60vh] print-area">
            <div id="lyricsContent" class="lyrics-container" style="font-size: 18px;">
                <div class="text-center text-slate-400 py-20">
                    請從上方選單選擇一首歌曲開始
                </div>
            </div>
        </div>
    </main>

    <footer class="max-w-4xl mx-auto px-4 py-8 text-center text-slate-400 text-sm no-print">
        &copy; 2025 慢一鐘頭的泰文歌同樂會
    </footer>

    <script>
        const jsonUrl = 'https://api.jsonbin.io/v3/b/6943bcfb43b1c97be9f69e92?meta=false';
        const proxyBase = 'https://corsproxy.io/?';
        
        let currentFontSize = 18;
        let allSongsData = null; 

        const songSelect = document.getElementById('songSelect');
        const lyricsContent = document.getElementById('lyricsContent');
        const loadingDiv = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const fontSizeDisplay = document.getElementById('fontSizeDisplay');
        // const downloadBtn = document.getElementById('downloadPdf');

        // 1. Initial Load
        async function init() {
            try {
                toggleLoading(true, "正在讀取歌單 JSON...");
                
                let response;
                // 嘗試多種抓取方式
                try {
                    response = await fetch(jsonUrl);
                    if (!response.ok) throw new Error();
                } catch (e) {
                    response = await fetch(proxyBase + encodeURIComponent(jsonUrl));
                }

                if (!response.ok) throw new Error('無法獲取 JSON 檔案');
                
                allSongsData = await response.json();
                console.log("Loaded Data:", allSongsData); // 偵錯用
                
                songSelect.innerHTML = '<option value="">請選擇歌曲...</option>';

                // 彈性解析選單
                 if (typeof allSongsData === 'object') {
                    Object.keys(allSongsData).forEach(key => {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = key;
                        songSelect.appendChild(option);
                    });
                }

                songSelect.disabled = false;
                toggleLoading(false);
            } catch (err) {
                console.error("Init Error:", err);
                lyricsContent.innerHTML = `
                    <div class="text-center py-10">
                        <p class="text-red-500 font-bold mb-2">錯誤：無法讀取資料</p>
                        <p class="text-slate-500 text-sm">${err.message}</p>
                        <button onclick="init()" class="mt-4 text-blue-500 underline text-sm">點此重試</button>
                    </div>`;
                toggleLoading(false);
            }
        }

        // 2. Handle Song Selection
        function handleSongChange(selectedValue) {
            if (selectedValue === "") {
                lyricsContent.innerHTML = '<div class="text-center text-slate-400 py-20">請從上方選單選擇一首歌曲開始</div>';
                return;
            }

            let songTitle = "";
            let lyricsLines = [];

            if (Array.isArray(allSongsData)) {
                const songObj = allSongsData[selectedValue];
                songTitle = songObj.title || songObj.name || `歌曲 ${parseInt(selectedValue) + 1}`;
                // 尋找內容欄位
                lyricsLines = songObj.lyrics || songObj.content || songObj.data || songObj.rows || [];
            } else {
                songTitle = selectedValue;
                lyricsLines = allSongsData[selectedValue];
            }

            renderLyrics(songTitle, lyricsLines);
        }

        // 3. Robust Lyrics Rendering
        function renderLyrics(title, lines) {
            // let html = `<h2 class="text-2xl md:text-3xl font-bold mb-8 border-b pb-4 text-center text-slate-700">${title}</h2>`;
            let html = ``;
            
            if (!Array.isArray(lines) || lines.length === 0) {
                html += `<p class="text-center text-slate-400 py-10">此歌曲暫無歌詞資料或格式不支援。</p>`;
                console.warn("Invalid lines structure:", lines);
            } else {
                lines.forEach((line, index) => {
                    let thai = "";
                    let chinese = "";

                    // 自動偵測多種資料格式
                    if (Array.isArray(line)) {
                        // 格式： ["泰文", "中文"]
                        thai = line[0] || "";
                        chinese = line[1].replace(/\n/g, '<br>') || "";
                    } else if (typeof line === 'object' && line !== null) {
                        // 格式： { thai: "...", chinese: "..." } 或 { th: "...", zh: "..." }
                        thai = line.thai || line.th || line.t || line.Thai || line.text_th || "";
                        chinese = line.chinese || line.zh || line.tw || line.c || line.Chinese || line.text_zh || "";
                        
                        // 如果物件中只有兩個值，但 key 不對，則取前兩個 value
                        if (!thai && !chinese) {
                            const values = Object.values(line);
                            thai = values[0] || "";
                            chinese = values[1] || "";
                        }
                    } else if (typeof line === 'string') {
                        // 格式： 只有字串（單行顯示）
                        thai = line;
                    }
                    
                    if (!thai && !chinese) return;
                    
                    // 過濾標題列（如泰文、中文等欄位名）
                    if (index === 0 && (thai.includes("泰文") || thai.toLowerCase() === "thai")) return;

                    if (index === 0) {
                        thai = thai.replace(/\n/g, '<br>');
                        chinese = chinese.replace(/\n/g, '<br>');
                        html += `<h2 class="text-2xl md:text-3xl font-bold mb-8 border-b pb-4 text-center text-slate-700">${thai}</br>${chinese}</h2>`

                        return;
                    }

                    html += `
                        <div class="lyric-pair">
                            <div class="thai-text">${thai}</div>
                            <div class="chinese-text">${chinese}</div>
                        </div>
                    `;
                });
            }

            lyricsContent.innerHTML = html;
        }

        function adjustFontSize(delta) {
            currentFontSize = Math.max(12, Math.min(48, currentFontSize + delta));
            lyricsContent.style.fontSize = `${currentFontSize}px`;
            fontSizeDisplay.textContent = `${currentFontSize}px`;
        }

        function toggleLoading(show, text = "載入中...") {
            loadingDiv.classList.toggle('hidden', !show);
            loadingText.textContent = text;
            if (show) lyricsContent.innerHTML = '';
        }

        // 4. PDF Generation
        // async function generatePDF() {
        //     const { jsPDF } = window.jspdf;
        //     const element = document.getElementById('lyricsDisplay');
        //     const songName = songSelect.options[songSelect.selectedIndex]?.text || "泰文歌詞";

        //     downloadBtn.disabled = true;
        //     downloadBtn.textContent = "生成中...";

        //     try {
        //         const canvas = await html2canvas(element, {
        //             scale: 2,
        //             useCORS: true,
        //             backgroundColor: "#ffffff",
        //             logging: false
        //         });
                
        //         const imgData = canvas.toDataURL('image/png');
        //         const pdf = new jsPDF('p', 'mm', 'a4');
                
        //         const imgProps = pdf.getImageProperties(imgData);
        //         const pdfWidth = pdf.internal.pageSize.getWidth();
        //         const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
        //         pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, Math.min(pdfHeight, 280)); 
        //         pdf.save(`${songName}.pdf`);
        //     } catch (err) {
        //         console.error("PDF Error:", err);
        //     } finally {
        //         downloadBtn.disabled = false;
        //         downloadBtn.innerHTML = `
        //             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
        //             下載 PDF
        //         `;
        //     }
        // }

        songSelect.addEventListener('change', (e) => handleSongChange(e.target.value));
        // downloadBtn.addEventListener('click', generatePDF);

        init();
    </script>
</body>
</html>